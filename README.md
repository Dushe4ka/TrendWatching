# Техническая документация бота TrendWatching

## Обзор системы

TrendWatching Bot - это Telegram бот для управления источниками новостей, анализа трендов и создания дайджестов. Система построена на основе ролевой модели доступа с интеграцией Lark Base для управления пользователями.

## Архитектура системы

### Основные компоненты:
- **Telegram Bot** (aiogram) - пользовательский интерфейс
- **Ролевая система** - управление правами доступа
- **Lark Base** - внешняя база данных пользователей
- **MongoDB** - внутренняя база данных ролей и синхронизированных данных
- **Периодическая синхронизация** - обновление данных из Lark Base каждые 10 минут

## Система прав доступа

### Права пользователей:
1. **`can_access_sources`** - доступ к источникам
2. **`can_access_analysis`** - доступ к анализу
3. **`can_access_subscriptions`** - доступ к подпискам
4. **`can_manage_telegram_auth`** - управление авторизацией Telegram
5. **`can_access_admin_panel`** - доступ к админ панели

### Роли по умолчанию:
- **admin** - полный доступ ко всем функциям
- **manager** - доступ к источникам и анализу
- **analyst** - доступ только к анализу
- **curator** - доступ к источникам и подпискам
- **viewer** - доступ только к подпискам
- **tester** - полный доступ к основным функциям

### Логика доступа:
- **ADMIN_ID** - пользователи из переменной окружения имеют полный доступ
- **Ролевые права** - определяют доступ к функциям на основе назначенной роли
- **Динамические клавиатуры** - кнопки отображаются в зависимости от прав пользователя

---

## 1. Раздел "Источники" (`can_access_sources`)

### Функциональность:
Раздел для управления источниками новостей и контента. Позволяет загружать, просматривать и управлять различными типами источников.

### 1.а. Загрузка источников

#### CSV-файл
- **Функция**: Загрузка источников из CSV-файла
- **Формат**: Столбцы с названием, URL, категорией, описанием
- **Валидация**: Проверка корректности URL и обязательных полей
- **Обработка**: Пакетная загрузка с обработкой ошибок

#### RSS-лента
- **Функция**: Добавление RSS-источников
- **Поддерживаемые форматы**: RSS 2.0, Atom, JSON Feed
- **Валидация**: Проверка доступности RSS-ленты
- **Автообновление**: Периодическое обновление контента

#### Telegram-канал
- **Функция**: Подключение Telegram каналов как источников
- **Требования**: Бот должен быть добавлен в канал как администратор
- **Автообнаружение**: Автоматическое определение каналов при добавлении бота
- **Мониторинг**: Отслеживание активности канала

### 1.б. Просмотр и удаление

#### Просмотр источников
- **Список источников**: Отображение всех доступных источников
- **Фильтрация**: По категориям, типу, статусу активности
- **Поиск**: По названию, URL, описанию
- **Статистика**: Количество публикаций, последняя активность

#### Удаление источников
- **Выборочное удаление**: Удаление отдельных источников
- **Массовое удаление**: Удаление по категориям или критериям
- **Подтверждение**: Запрос подтверждения перед удалением
- **Архивирование**: Сохранение истории удаленных источников

### 1.с. Парсинг источников

#### Автоматический парсинг
- **Расписание**: Периодический парсинг по расписанию
- **Триггеры**: Парсинг по событиям (новые публикации)
- **Приоритеты**: Настройка приоритетов для разных источников

#### Ручной парсинг
- **Запрос парсинга**: Принудительный парсинг выбранных источников
- **Результаты**: Отображение результатов парсинга
- **Ошибки**: Обработка и отображение ошибок парсинга

#### Обработка контента
- **Извлечение текста**: Очистка и нормализация текста
- **Метаданные**: Сохранение заголовков, дат, авторов
- **Медиафайлы**: Обработка изображений и видео
- **Дубликаты**: Обнаружение и обработка дублирующегося контента

---

## 2. Раздел "Анализ" (`can_access_analysis`)

### Функциональность:
Раздел для анализа контента, создания отчетов и генерации дайджестов на основе собранных данных.

### 2.а. Анализ по запросу

#### Текстовый анализ
- **Ключевые слова**: Выявление популярных тем и терминов

### 2.б. Дайджест новостей

#### Ежедневный дайджест
- **Автоматическая генерация**: Ежедневные отчеты в заданное время
- **Структура**: Краткое содержание, ключевые события, тренды
- **Персонализация**: Адаптация под интересы пользователя

#### Еженедельный дайджест
- **Сводка недели**: Обзор ключевых событий за неделю
- **Тренды**: Анализ долгосрочных трендов

#### Настройка дайджестов
- **Содержание**: Выбор разделов для включения

---

## 3. Раздел "Подписки" (`can_access_subscriptions`)

### Функциональность:
Система подписок на различные категории контента с персонализированными уведомлениями.

#### Управление подписками
- **Подписка на категории**: Выбор интересующих тем

#### Типы уведомлений
- **Ежедневные**: Сводка за день
- **Персональные**: Адаптированные под интересы пользователя

#### Персонализация
- **Алгоритмы рекомендаций**: Предложение релевантного контента

---

## 4. Раздел "Авторизация" (`can_manage_telegram_auth`)

### Функциональность:
Управление Telegram аккаунтами для парсинга контента и мониторинга каналов.

### 4.а. Добавить аккаунт

#### Процесс авторизации
- **Ввод номера телефона**: Формат +7XXXXXXXXXX
- **Подтверждение кода**: SMS-код от Telegram
- **Двухфакторная аутентификация**: При необходимости
- **Проверка статуса**: Верификация успешной авторизации

#### Интеграция с сервисом
- **AUTH_SERVICE_URL**: Внешний сервис авторизации
- **API_ID/API_HASH**: Telegram API credentials
- **Асинхронные запросы**: Неблокирующая авторизация
- **Обработка ошибок**: Graceful handling исключений

### 4.б. Статус авторизации

#### Мониторинг сессий
- **Список аккаунтов**: Все авторизованные аккаунты
- **Статус сессий**: Активные/неактивные сессии
- **Статистика использования**: Количество каналов на аккаунт
- **Проблемы**: Обнаружение и отображение проблем

#### Проверка работоспособности
- **Тест подключения**: Проверка доступности аккаунтов
- **Валидация сессий**: Проверка корректности токенов
- **Автоматическое восстановление**: Попытки восстановления сессий

### 4.с. Удалить аккаунт

#### Процесс удаления
- **Выбор аккаунта**: Выбор аккаунта для удаления
- **Подтверждение**: Запрос подтверждения операции
- **Очистка данных**: Удаление связанных данных
- **Перераспределение каналов**: Перенос каналов на другие аккаунты

### 4.d. Сервис авторизации

#### Распределить каналы
- **Автоматическое распределение**: Равномерное распределение каналов
- **Балансировка нагрузки**: Оптимизация нагрузки на аккаунты
- **Мониторинг**: Отслеживание эффективности распределения

#### Очистить дубликаты
- **Обнаружение дубликатов**: Поиск повторяющихся каналов
- **Автоматическая очистка**: Удаление дублирующихся записей
- **Отчеты**: Статистика очищенных дубликатов

#### Очистить все каналы
- **Массовая очистка**: Удаление всех каналов
- **Подтверждение**: Множественные подтверждения

---

## 5. Раздел "Админ" (`can_access_admin_panel`)

### Функциональность:
Административная панель для управления системой, пользователями и настройками.

### 5.а. Микросервис

#### Распределить каналы
- **Системное распределение**: Распределение на уровне микросервиса
- **Оптимизация производительности**: Улучшение работы системы
- **Логирование**: Детальные логи операций

#### Очистить дубликаты
- **Системная очистка**: Удаление дубликатов на уровне БД
- **Индексы**: Оптимизация индексов после очистки
- **Статистика**: Отчеты о результатах очистки
- **Производительность**: Улучшение скорости работы

#### Очистить все каналы
- **Системная очистка**: Полная очистка всех каналов
- **Безопасность**: Множественные проверки безопасности
- **Аудит**: Логирование всех операций

### 5.б. Роли

#### Создать роль
- **Форма создания**: Интерфейс для создания новой роли
- **Настройка прав**: Выбор разрешений для роли
- **Валидация**: Проверка корректности данных
- **Подтверждение**: Сохранение роли в системе

#### Редактировать роль
- **Выбор роли**: Интерфейс выбора роли для редактирования
- **Изменение прав**: Модификация разрешений
- **Обновление**: Сохранение изменений

#### Список ролей
- **Отображение ролей**: Список всех ролей в системе
- **Детальная информация**: Права и описание каждой роли
- **Статистика**: Количество пользователей с каждой ролью

#### Пользователи
- **Список пользователей**: Все пользователи системы
- **Информация о пользователях**: Роли, статусы, активность
- **Управление ролями**: Назначение и изменение ролей

### 5.с. Telegram каналы

#### Список каналов
- **Отображение каналов**: Все подключенные каналы
- **Информация о каналах**: Название

#### Выбор канала
- **Интерфейс выбора**: Удобный выбор канала
- **Детальная информация**: Полная информация о канале
- **Быстрые действия**: Доступ к основным функциям

#### Добавить дайджест
- **Форма создания**: Интерфейс создания дайджеста
- **Настройки**: Время отправки, категории
- **Валидация**: Проверка корректности настроек
- **Сохранение**: Создание дайджеста в системе

#### Редактировать дайджест
- **Выбор дайджеста**: Интерфейс выбора для редактирования
- **Изменение настроек**: Модификация параметров
- **Предварительный просмотр**: Показ результата изменений
- **Сохранение**: Обновление дайджеста

#### Инициализировать расписание
- **Настройка расписания**: Конфигурация времени отправки
- **Часовые пояса**: Учет временных зон
- **Активация**: Запуск расписания

#### Проверить расписание
- **Статус расписания**: Текущее состояние
- **История выполнения**: Логи отправок
- **Проблемы**: Обнаружение и отображение ошибок
- **Тестирование**: Проверка работы расписания

---

## Система синхронизации

### Периодическая синхронизация с Lark Base:
- **Интервал**: Каждые 10 минут
- **Автоматический запуск**: При старте системы
- **Обработка ошибок**: Graceful handling исключений
- **Логирование**: Детальные логи синхронизации

### Что синхронизируется:
- **Данные пользователей** из Lark Base
- **Роли** пользователей
- **Статусы** сотрудников
- **Telegram username**
- **Email** сотрудников

### Процесс синхронизации:
1. Получение токена доступа к Lark API
2. Запрос всех записей из таблицы пользователей
3. Обработка и нормализация данных
4. Сохранение в MongoDB (коллекция `users_lark`)
5. Обновление кэша пользователей

---

## Динамические клавиатуры

### Логика отображения кнопок:
- **Проверка прав**: Отображение кнопок на основе ролевых прав
- **Контекстные меню**: Адаптация под текущий раздел
- **Иерархическая навигация**: Логичная структура меню

### Типы клавиатур:
1. **Админская клавиатура** - для пользователей с `ADMIN_ID`
2. **Динамическая клавиатура** - на основе ролевых прав
3. **Контекстные клавиатуры** - для конкретных разделов

---

## Система логирования

### Уровни логирования:
- **DEBUG** - детальная отладочная информация
- **INFO** - общая информация о работе системы
- **WARNING** - предупреждения
- **ERROR** - ошибки системы

### Логируемые события:
- Проверки доступа пользователей
- Синхронизация с Lark Base
- Операции с ролями и правами
- Ошибки в работе компонентов
- Административные действия

---

## Конфигурация системы

### Переменные окружения:
```bash
# Telegram Bot
BOT_TOKEN=your_bot_token

# Lark Base
LARK_APP_ID=your_app_id
LARK_APP_SECRET=your_app_secret
LARK_TABLE_APP_ID=your_table_app_id
LARK_TABLE_ID=your_table_id

# Администраторы
ADMIN_ID=..., ...

# Авторизация Telegram
AUTH_SERVICE_URL=http://localhost:8000
API_ID=your_api_id
API_HASH=your_api_hash

# MongoDB
MONGODB_URI=mongodb://localhost:27017/blackbox
```

### Настройки по умолчанию:
- **Интервал синхронизации**: 10 минут
- **Кэширование токенов**: 1 час
- **Таймаут запросов**: 30 секунд
- **Максимальное количество попыток**: 3

---

## Безопасность

### Механизмы защиты:
1. **Ролевая модель доступа** - проверка прав на каждое действие
2. **Валидация входных данных** - проверка корректности данных
3. **Логирование действий** - отслеживание всех операций
4. **Обработка ошибок** - graceful handling исключений
5. **Кэширование токенов** - безопасное хранение credentials

### Проверки безопасности:
- Валидация Telegram username
- Проверка существования пользователя в системе
- Верификация ролей и прав доступа
- Защита от SQL-инъекций (MongoDB)
- Rate limiting для API запросов

---

## Мониторинг и диагностика

### Метрики системы:
- Количество активных пользователей
- Статистика использования функций
- Время отклика API
- Частота синхронизации
- Ошибки и исключения

### Диагностические команды:
- `/start` - проверка доступа пользователя
- `/main_menu` - отображение доступных функций
- Админские функции мониторинга

### Отладочная информация:
- Детальные логи всех операций
- Информация о состоянии кэша
- Статус подключений к внешним сервисам
- Производительность запросов

---

## Заключение

TrendWatching Bot представляет собой комплексную систему управления контентом с гибкой ролевой моделью доступа. Система обеспечивает:

- **Масштабируемость** - модульная архитектура
- **Безопасность** - многоуровневая система прав доступа
- **Надежность** - обработка ошибок и мониторинг
- **Удобство** - интуитивный интерфейс и динамические клавиатуры
- **Интеграцию** - связь с внешними системами (Lark Base, Telegram API)

Система готова к продуктивному использованию и дальнейшему развитию. 